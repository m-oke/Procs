<%= render "layouts/notice" %>
<div class="btn-right">
  <% if @is_teacher && session[:seleted_lesson] != "private_lesson"  %>
    <%= link_to "問題新規作成",new_lesson_question_path(:lesson_id => @lesson.id) ,:remote => true ,:class=>"btn btn-primary" %>
  <% end %>
</div>
<div>
  <% deleted_question_protected=[] %>
  <% deleted_question_hidden=[] %>
  <% if @lesson.id> 1  %>
      <% lesson_all_question = LessonQuestion.where(:lesson_id => @lesson.id,:is_deleted =>true ) %>
      <% lesson_all_question.each do |q| %>
          <% answers = Answer.where(:lesson_id=>@lesson.id, :question_id =>q['question_id'])%>
          <% if answers.count>0%>
              <% deleted_question_protected.push(q['question_id'])%>
          <% else%>
              <% deleted_question_hidden.push(q['question_id']) %>
          <% end %>
      <% end%>
  <% end%>
  <h2>問題一覧</h2>
  <div class="table-responsive">
    <% unless @is_teacher %>
      <div>
        <div style="float:right;"><p>問題変更前の回答です</p></div>
        <div style="float:right;"><div class="old_version_color_block"></div></div>
      </div>
    <% end %>
    <table class="table table-bordered table-striped">
      <tr>
        <th>問題ID</th>
        <th>問題名</th>
        <% if @lesson.id != 1 %>
          <th>開始時間</th>
          <th>終了時間</th>
        <% end %>
        <% unless @is_teacher %>
          <th>結果</th>
          <th>解答</th>
          <th>解答詳細</th>
        <% end %>
      </tr>
      <% i = 0 %>
      <% @questions.each do |question| %>
        <% if deleted_question_protected.include?(question.id) || deleted_question_hidden.include?(question.id) %>
          <% next %>
        <% end %>
        <% i += 1 %>
        <% question = Question.find_by(:id => lesson_question.question_id) %>
        <tr>
          <td><%= i %></td>
          <td>
            <% if @lesson.id != 1 %>
              <%= link_to(question.title, lesson_question_path(:lesson_id => params[:lesson_id],
                                                               :question_id => question.id,
                                                               :lesson_question_id => lesson_question.id),:remote =>true) %>
            <% else %>
              <%= link_to(question.title, question_path(:question_id => question.id, :lesson_question_id => lesson_question.id)) %>
            <% end %>
          </td>

          <% if @lesson.id != 1 %>
            <td>
              <% if lesson_question.start_time.nil? %>
                <%= lesson_question.start_time %>
              <% else %>
                <%= lesson_question.start_time.strftime(" %Y /  %m / %d - %H:%M:%S ")  %>
              <% end %>
            </td>
            <td>
              <% if lesson_question.end_time.nil? %>
                <%= lesson_question.end_time %>
              <% else %>
                <%= lesson_question.end_time.strftime(" %Y /  %m / %d - %H:%M:%S ") %>
              <% end %>
            </td>
          <% end %>

          <% unless @is_teacher %>
            <% @latest_answer = Answer.latest_answer(:student_id => current_user.id,
                                                     :question_id => question.id,
                                                     :lesson_id => @lesson.id,
                                                     :lesson_question_id => lesson_question.id) || Answer.new %>

            <% if question.version == @latest_answer.question_version %>
              <td><%= RESULT[@latest_answer.result] %></td>
            <% else %>
              <% if RESULT[@latest_answer.result].to_s.empty?%>
                <td ><%= RESULT[@latest_answer.result] %></td>
              <% else %>
                <td class = "old_version_color"><%= RESULT[@latest_answer.result] %></td>
              <% end %>
            <% end %>
            <td>
              <% if @lesson.id != 1 %>
                <!--現在時間と開始時間・終了時間を比較し、時間内かどうかを確認する-->
                <% if (lesson_question.start_time.nil? || lesson_question.start_time.to_time < Time.now) &&
                       (lesson_question.end_time.nil? || Time.now < lesson_question.end_time.to_time) %>
                <%= button_to('解答', lesson_question_path(:lesson_id => params[:lesson_id],
                                                           :question_id => question.id,
                                                           :lesson_question_id => lesson_question.id) + '#answer',
                              :method => :get, :remote => true, class: 'btn btn-default') %>
                <% else %>
                  <%= button_to('解答', lesson_question_path(:lesson_id => params[:lesson_id],
                                                             :question_id => question.id,
                                                             :lesson_question_id => lesson_question.id),
                                :method => :get, :disabled => true, :remote => true, class: 'btn btn-default') %>
                <% end %>
              <% else %>
                <%= button_to('解答', question_path(:question_id => question.id, :lesson_question_id => lesson_question.id) + '#answer', :method => :get, class: 'btn btn-default') %>
              <% end %>
            </td>
            <td>
              <% if @lesson.id != 1 %>
                <%= button_to('解答詳細', answers_lesson_question_path(:lesson_id => @lesson.id,
                                                                       :question_id => question.id,
                                                                       :lesson_question_id => lesson_question.id),
                              :method => :get, :disabled => (@latest_answer.new_record?), :remote => true, class: 'btn btn-default') %>
              <% else %>
                <%= button_to('解答詳細', answers_question_path(:question_id => question.id, :lesson_question_id => lesson_question.id),
                              :method => :get, :disabled => (@latest_answer.new_record?), class: 'btn btn-default') %>
              <% end %>

            </td>
          <% end %>
        </tr>
      <% end %>
    </table>
  </div>
  <% if @is_teacher && @lesson.id != 1 && deleted_question_protected.size > 0 %>
  <h2>非公開問題一覧</h2>
  <p>削除した問題は既に解答があるので、解答データを安全管理するため、問題を非公開に移動します</p>
  <p>非公開から公開に変更したい場合、管理者と連絡してください</p>
  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <tr>
        <th>問題ID</th>
        <th>問題名</th>
        <th>開始時間</th>
        <th>終了時間</th>
      </tr>
      <% ii = 0 %>
      <% @questions.each do |question| %>
          <% if deleted_question_protected.include?(question.id) %>
              <% ii += 1 %>
              <td><%= ii  %></td>
              <td>
                <%= link_to(question.title, lesson_question_path(:lesson_id => params[:lesson_id], :question_id => question.id),:remote =>true) %>
              </td>
              <td>
                <% if @lesson.lesson_questions.find_by(:question_id => question.id).start_time.nil? %>
                    <%= @lesson.lesson_questions.find_by(:question_id => question.id).start_time %>
                <% else %>
                    <%= @lesson.lesson_questions.find_by(:question_id => question.id).start_time.strftime(" %Y /  %m / %d - %H:%M:%S ")  %>
                <% end %>
              </td>
              <td>
                <% if @lesson.lesson_questions.find_by(:question_id => question.id).end_time.nil? %>
                    <%= @lesson.lesson_questions.find_by(:question_id => question.id).end_time %>
                <% else %>
                    <%= @lesson.lesson_questions.find_by(:question_id => question.id).end_time.strftime(" %Y /  %m / %d - %H:%M:%S ") %>
                <% end %>
              </td>
          <% end %>
      <% end %>
    </table>
  </div>
  <% end %>
</div>
<% flash[:previous] = 'questions' %>
