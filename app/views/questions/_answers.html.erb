<script type="text/javascript">

  jQuery(document).ready(function(){
  jQuery(".draw_fancybox").fancybox({
  maxWidth    : 800,
  maxHeight   : 600,
  fitToView   : false,
  width       : '70%',
  height      : '70%',
  autoSize    : false,
  closeClick  : false,
  openEffect  : 'none',
  closeEffect : 'none'
  });
  });
</script>
<h3 id="answer">解答状況</h3>

<div>
  <div style="float:left;">
    <% if @multi_check_enable == true %>
      <%= button_to "全員のWEB剽窃チェック", lessons_internet_check_path(:lesson_id => @lesson.id,
                                                                         :student_id => 0,
                                                                         :question_id => params[:question_id]), {:remote => true , :method => "post",:class=>"btn btn-default", :id => "multi_check_internet" }%>
    <% else %>
      <a class="btn btn-default disabled" >全員のWEB剽窃チェック</a>
    <% end %>

  </div>
  <div style="float:left;">
    <p class ="text_align_user", id='check_message_internet'>WEB剽窃チェックの結果を確認するために、ページを更新してください</p>
  </div>
  <div style="clear:both"></div>
</div>

<div class="table-responsive">
  <div>
    <div style="float:right;"><p>問題変更前の回答です</p></div>
    <div style="float:right;"><div class="old_version_color_block"></div></div>
  </div>
  <table class="table table-bordered table-striped">
    <tr>
      <th>学籍番号</th>
      <th>氏名</th>
      <th>提出時間</th>
      <th>結果</th>
      <th>実行時間(ms)</th>
      <th>メモリ使用量(MB/KB)</th>
      <th>使用言語</th>
      <th>学生同士の類似度</th>
      <th>WEB類似度</th>

    </tr>
    <% @students.each do |student| %>
      <% answer = Answer.latest_answer(:student_id => student.id,
                                       :question_id => params[:question_id],
                                       :lesson_id => @lesson.id,
                                       :lesson_question_id => session[:lesson_question_id]) || Answer.new
         %>

      <tr>
        <td>
          <% unless answer.new_record? %>
            <%= link_to(student.student_number, lesson_student_answers_path(:lesson_id => @lesson.id,
                                                                            :question_id => @question.id,
                                                                            :student_id => student.id), :remote => ( @lesson.id != 1)) %>
          <% else %>
            <%= student.student_number %>
          <% end %>
        </td>
        <td><%= student.name %></td>
        <td><%= answer.created_at %> </td>
        <% if @question.version == answer.question_version %>
          <td><%= RESULT[answer.result] %></td>
        <% else %>
          <% if RESULT[answer.result].to_s.empty?%>
            <td ><%= RESULT[answer.result] %></td>
          <% else %>
            <td class = "old_version_color"><%= RESULT[answer.result] %></td>
          <% end %>
      <% end %>
      <td><%= answer.run_time %></td>
      <td><%= answer.memory_usage %></td>
      <td><%= answer.language.capitalize unless answer.language.nil? %></td>
      <!-- ローカル類似度の表示 -->
      <td>
        <% unless answer.new_record? %>
            <a class="draw_fancybox" href="#local_checked_results_<%=student.id %>" ><%= answer.plagiarism_percentage %>%</a>
        <% end %>
      </td>
      <td>
        <% title_nil_exist = 0 %>
        <% checked_result = InternetCheckResult.where(:answer_id =>answer.id)%>
        <% nil_title = InternetCheckResult.where(:answer_id =>answer.id, :title => nil)%>
        <% if nil_title.present? %>
            <% nil_title.each do |r| %>
              <% if r['answer_id'] == answer.id %>
                <% title_nil_exist = 1 %>
                <% break %>
              <% end %>
            <% end %>
          <% end %>
          <% if checked_result.size > 0 && title_nil_exist == 0 %>
            <a class="btn btn-default draw_fancybox" href="#internet_results_checked_question_<%=student.id%>" >表示</a>
          <% elsif title_nil_exist == 1  %>
            <a class="btn btn-default disabled" >チェック中</a>
          <% elsif RESULT[answer.result].to_s.present? %>
            <span>
              <%= button_to "チェック", lessons_internet_check_path(:lesson_id => @lesson.id,
                                                                    :student_id => student.id,
                                                                    :question_id => params[:question_id]), {:remote => true , :method => "post", :id => "question_ajax_link_#{student.id}",:class=>"btn btn-default" }%>
              <a id="question_display_<%=student.id%>" class="btn btn-default draw_fancybox draw_fancybox_hidden" href="#internet_check_results_<%=student.id %>" >表示</a>
            </span>
        <% else %>
        <% end %>
      </td>
      <!-- Localウィンドウ表示内容-->
      <div id="local_checked_results_<%=student.id %>" class="internet-check-results-css" >
        <% unless answer.new_record? %>
            <% unless answer.plagiarism_percentage == 0.0 %>
            <!--データベースからデータを取得-->
            <% local_check_result = LocalCheckResult.find_by(:answer_id => answer.id) %>
            <% @target_line = local_check_result.target_line %>
            <% @compare_line = local_check_result.compare_line %>
            <% @target_path = @target_file = UPLOADS_ANSWERS_PATH.join(student.id.to_s, answer.lesson_question_id.to_s, answer.file_name).to_s %>
            <% @compare_path = local_check_result.check_file %>

            <!--Mark the check line-->
            <% @target_check_count = @target_line.count(";") %>
            <% @compare_check_count = @compare_line.count(";") %>
            <% t_line = @target_line.scan(/\d+/) %>
            <% c_line = @compare_line.scan(/\d+/) %>
            <% @t_line = t_line.map(&:to_i).sort %>
            <% @c_line = c_line.map(&:to_i).sort %>

            <!--ソースコード内容の取得-->
            <% @target_code = show_local(@target_path) %>
            <% @compare_code = show_local(@compare_path) %>
            <div class="check_result">
                <p>学生：<%= student.name %></p>
                <p>問題：<%= @question.title %></p>
                <p>ソースコード：</p>
                <div class="hero-unit3">
                    <% @target_code.each_with_index do |line, i| %>
                      <% for j in 0..@target_check_count-1 %>
                        <% if i >= @t_line[j*2] && i <= @t_line[j*2+1] %>
                            <p class="red"> <%= line %> </p>
                        <% elsif i < @t_line[j*2] && i > @t_line[j*2-1] %>
                            <p> <%= line %> </p>
                        <% end %>
                      <% end %>
                      <% if i < @t_line[0] || i > @t_line[@target_check_count*2-1] %>
                        <p> <%= line %> </p>
                      <% end %>
                    <% end %>
                </div>
            </div>

            <div class="check_result">
                <p>類似ファイルのパス：<%= @compare_path %></p>
                <p>ソースコード：</p>
                <div class="hero-unit3">
                  <% @compare_code.each_with_index do |line, i| %>
                      <% for j in 0..@compare_check_count-1 %>
                          <% if i >= @c_line[j*2] && i <= @c_line[j*2+1] %>
                              <p class="red"> <%= line %> </p>
                          <% elsif i < @c_line[j*2] && i > @c_line[j*2-1] %>
                              <p> <%= line %> </p>
                          <% end %>
                      <% end %>
                      <% if i < @c_line[0] || i > @c_line[@compare_check_count*2-1] %>
                          <p> <%= line %> </p>
                      <% end %>
                  <% end %>
                </div>
            </div>
            <% else %>
                <p>類似ファイルは存在しません</p>
            <% end %>
        <% end %>

      </div>
      <div id="internet_results_checked_question_<%=student.id%>" class="internet-check-results-css" >

          <p>学生：<%= student.name %></p>
          <p>問題：<%= @question.title %></p>
          <% max_time = 0 %>
          <% checked_result.each do |r|%>
            <% if r['repeat'].to_i > 1 %>
              <% max_time=r['repeat'].to_i %>
              <% break %>
            <% end %>
          <% end %>
          <% if max_time > 1 %>
            <p>WEB剽窃チェックの結果：解答に関連があるWEBページを検出しました</p>

            <% checked_result.each do |result| %>
              <div class="hero-unit2">
                <p>関連タイトル：<%= result['title'] %></p>
                <p>関連リンク：<%= link_to result['link'],"#{result['link']}", :target => ["'_blank'"] %></p>
                <p>回数：<%= result['repeat'] %></p>
                <p>内容：<%= result['content'] %></p>
              </div>
            <% end %>
          <%else %>
            <p>WEB剽窃チェックの結果：解答に関連があるWEBページを検出できませんでした</p>
          <%end %>
        </div>
      </tr>
    <% end %>
  </table>
</div>
<%  @students.each do |student| %>
  <div id="internet_check_results_<%=student.id %>" class="internet-check-results-css" >
  </div>
<% end %>
