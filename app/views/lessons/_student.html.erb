<script type="text/javascript">

    jQuery(document).ready(function(){
        jQuery(".draw_fancybox").fancybox({
            maxWidth    : 1200,
            maxHeight   : 600,
            fitToView   : false,
            width       : '70%',
            height      : '70%',
            autoSize    : false,
            closeClick  : false,
            openEffect  : 'none',
            closeEffect : 'none'
        });
    });
</script>
<%= link_to "学生一覧に戻る", students_lessons_path(:lesson_id => params[:lesson_id]), :remote => true , :method => "GET" , :class=>"btn btn-default btn_top" %>
<h1>学生詳細ページ</h1>

  <table class="student">
    <tbody>
      <tr>
        <th>名前</th>
        <td><%= @student.name %></td>
      </tr>
      <tr>
        <th>学籍番号</th>
        <td><%= @student.student_number %></td>
      </tr>
      <tr>
        <th>emailアドレス</th>
        <td><%= @student.email %></td>
      </tr>
    </tbody>
  </table>
<h2>解答状況</h2>
<div>
  <div>
    <div style="float:right;"><p>問題変更前の回答です</p></div>
    <div style="float:right;"><div class="old_version_color_block"></div></div>
  </div>
  <table class="table table-bordered table-striped">
    <tr>
      <th>問題番号</th>
      <th>問題名</th>
      <th>結果</th>
      <th>実行時間(ms)</th>
      <th>メモリ使用量(MB/KB)</th>
      <th>終了時間</th>
      <th>提出</th>
      <th>学生同士の類似度</th>
      <% unless ENV['BING_APIKEY'].nil? %>
      <th>WEB剽窃チェック</th>
      <% end %>
    </tr>
    <% num = 0 %>
    <% @lesson_questions.each do |lesson_question| %>
        <tr>
          <% if lesson_question['is_deleted'] == true  %>
              <% next %>
          <% end %>

          <% num = num + 1 %>
          <% question = Question.find_by(:id => lesson_question.question_id) %>
          <% answer = Answer.latest_answer(:lesson_id => @lesson_id ,:student_id => @student.id ,:question_id => lesson_question.question_id, :lesson_question_id => lesson_question.id) %>
          <td><%= num  %></td>
          <% unless answer.nil? %>
              <td class="table-question-title-css"><%= link_to question.title, lesson_student_answers_path(:lesson_id => @lesson_id,
                                                                          :question_id => question.id,
                                                                          :student_id => @student.id,
                                                                          :lesson_question_id => lesson_question.id),:remote => true  %></td>
              <% if question.version == answer.question_version %>
                  <td><%= RESULT[answer.result] %></td>
              <% else %>
                  <% if RESULT[answer.result].to_s.empty?%>
                      <td ><%= RESULT[answer.result] %></td>
                  <% else %>
                      <td class = "old_version_color"><%= RESULT[answer.result] %></td>
                  <% end %>
              <% end %>
              <td><%= answer.run_time %></td>
              <% if answer.memory_usage / 1024 == 0 %>
                  <td><%= "#{answer.memory_usage} KB" %></td>
              <% else %>
                  <td><%= "#{answer.memory_usage / 1024} MB" %></td>
              <% end %>
              <td><%= lesson_question.end_time %></td>
              <td><%= answer.created_at %></td>
              <!-- ローカル類似度表示 -->
              <td>
                <span>
                  <% unless answer.new_record? %>
                    <p><%= answer.plagiarism_percentage %>%</p>
                    <a class="btn btn-default draw_fancybox" href="#local_checked_results_<%=lesson_question.question_id %>" >内容を確認</a>
                  <% end %>
                </span>
              </td>
              <!-- Localウィンドウ表示内容-->
              <div id="local_checked_results_<%=lesson_question.question_id %>" class="internet-check-results-css" >
                <% unless answer.new_record? %>
                    <% unless answer.plagiarism_percentage == 0.0 %>
                        <!--データベースからデータを取得-->
                        <% local_check_result = LocalCheckResult.find_by(:answer_id => answer.id) %>
                        <% @target_line = local_check_result.target_line %>
                        <% @compare_line = local_check_result.compare_line %>
                        <% @target_path = @target_file = UPLOADS_ANSWERS_PATH.join(@student.id.to_s, answer.lesson_question_id.to_s, answer.file_name).to_s %>
                        <% @compare_path = local_check_result.check_file %>

                        <!--Mark the check line-->
                        <% @target_check_count = @target_line.count(";") %>
                        <% @compare_check_count = @compare_line.count(";") %>
                        <% t_line = @target_line.scan(/\d+/) %>
                        <% c_line = @compare_line.scan(/\d+/) %>
                        <% @t_line = t_line.map(&:to_i).sort %>
                        <% @c_line = c_line.map(&:to_i).sort %>

                        <!--ソースコード内容の取得-->
                        <% @target_code = show_local(@target_path) %>
                        <% @compare_code = show_local(@compare_path) %>
                        <div class="check_result">
                          <p>学生：<%= @student.name %></p>
                          <p>問題：<%= question.title %></p>
                          <p>ソースコード：</p>
                          <div class="hero-unit3">
                            <% @target_code.each_with_index do |line, i| %>
                                <% for j in 0..@target_check_count-1 %>
                                    <% if i >= @t_line[j*2] && i <= @t_line[j*2+1] %>
                                        <p class="red"> <%= line %> </p>
                                    <% elsif i < @t_line[j*2] && i > @t_line[j*2-1] %>
                                        <p> <%= line %> </p>
                                    <% end %>
                                <% end %>
                                <% if i < @t_line[0] || i > @t_line[@target_check_count*2-1] %>
                                    <p> <%= line %> </p>
                                <% end %>
                            <% end %>
                          </div>
                        </div>

                        <div class="check_result">
                          <p>類似ファイルのパス：<%= @compare_path %></p>
                          <p>ソースコード：</p>
                          <div class="hero-unit3">
                            <% @compare_code.each_with_index do |line, i| %>
                                <% for j in 0..@compare_check_count-1 %>
                                    <% if i >= @c_line[j*2] && i <= @c_line[j*2+1] %>
                                        <p class="red"> <%= line %> </p>
                                    <% elsif i < @c_line[j*2] && i > @c_line[j*2-1] %>
                                        <p> <%= line %> </p>
                                    <% end %>
                                <% end %>
                                <% if i < @c_line[0] || i > @c_line[@compare_check_count*2-1] %>
                                    <p> <%= line %> </p>
                                <% end %>
                            <% end %>
                          </div>
                        </div>
                    <% else %>
                        <p>類似ファイルは存在しません</p>
                    <% end %>
                <% end %>
              </div>
              <% unless ENV['BING_APIKEY'].nil? %>
                <td>

                    <% http_error_exist = 0 %>
                    <% key_word_change = 0 %>
                    <% question_keyword = '' %>

                    <% question_keywords = QuestionKeyword.where(:question_id => question['id']) %>
                    <% question_keywords.each do |k| %>
                        <% question_keyword = question_keyword + " " + k['keyword'] %>
                    <% end %>
                    <% checked_result = InternetCheckResult.where(:answer_id =>answer.id)%>
                    <% if checked_result.present?%>
                        <% checked_result.each do |r|%>
                            <% if r['key_word'] != question_keyword %>
                                <% key_word_change = 1%>
                                <% break %>
                            <% end %>
                        <% end %>
                    <% end %>
                    <% http_error = InternetCheckResult.where(:answer_id =>answer.id, :title => nil, :link => '', :content => '' )%>
                    <% if http_error.present? %>
                        <% http_error.each do |r| %>
                            <% if r['answer_id'] == answer.id %>
                                <% http_error_exist = 1 %>
                                <% break %>
                            <% end %>
                        <% end %>
                    <% end %>
                    <% if question_keyword !='' %>
                        <% if key_word_change == 0 %>
                            <% if checked_result.size > 0 && http_error_exist == 0 %>
                                <a class="btn btn-default draw_fancybox" href="#internet_results_checked_<%=lesson_question.question_id %>" >表示</a>
                            <% elsif checked_result.size == 0 && answer.result== 'A' %>
                                <%# elsif checked_result.size == 0 %>
                                <span>
                              <%= button_to "チェック", lessons_internet_check_path(:lesson_id => @lesson_id,
                                                                                :student_id => @student.id,
                                                                                :question_id => lesson_question.question_id ), {:remote => true , :method => "post", :id => "ajax_link_#{lesson_question.question_id}",:class=>"btn btn-default" }%>
                                  <a id="display_<%=lesson_question.question_id%>" class="btn btn-default draw_fancybox draw_fancybox_hidden" href="#internet_check_results_<%=lesson_question.question_id %>" >表示</a>
                            </span>
                            <% elsif checked_result.size > 0 && http_error_exist == 1%>
                            <span>
                              <%= button_to "チェック", lessons_internet_check_path(:lesson_id => @lesson_id,
                                                                                :student_id => @student.id,
                                                                                :question_id => lesson_question.question_id ), {:remote => true , :method => "post", :id => "ajax_link_#{lesson_question.question_id}",:class=>"btn btn-default" }%>
                              <a class="btn btn-default draw_fancybox" href="#internet_results_checked_<%=lesson_question.question_id %>" >表示</a>
                            </span>

                            <% else %>
                            <span>
                              <%= button_to "チェック", lessons_internet_check_path(:lesson_id => @lesson_id,
                                                                                :student_id => @student.id,
                                                                                :question_id => lesson_question.question_id ), :remote => true , :disabled => "true", :id => "ajax_link_#{lesson_question.question_id}", :method => "post", :class=>"btn btn-default" %>
                            </span>
                            <% end %>
                        <% else %>
                        <span>
                          <%= button_to "チェック", lessons_internet_check_path(:lesson_id => @lesson_id,
                                                                            :student_id => @student.id,
                                                                            :question_id => lesson_question.question_id ), {:remote => true , :method => "post", :id => "ajax_link_#{lesson_question.question_id}",:class=>"btn btn-default" }%>
                          <a id="display_<%=lesson_question.question_id%>" class="btn btn-default draw_fancybox draw_fancybox_hidden" href="#internet_check_results_<%=lesson_question.question_id %>" >表示</a>
                        </span>
                        <% end %>
                    <% end %>
                </td>
                <td style="display:none">
                  <div id="internet_results_checked_<%=lesson_question.question_id %>" class="internet-check-results-css" >

                    <p>学生：<%= @student.name %></p>
                    <p>学生：<%= @student.nickname %></p>
                    <p>問題：<%= question.title %></p>
                    <% max_time = 0 %>

                    <% checked_result.each do |r|%>
                        <% if r['repeat'].to_i > 1 %>
                            <% max_time=r['repeat'].to_i %>
                            <% break %>
                        <% end %>
                    <% end %>

                    <% if max_time > 1 %>
                        <p>WEB剽窃チェックの結果：解答に関連があるWEBページを検出しました</p>

                        <% checked_result.each do |result| %>
                            <div class="hero-unit2">
                              <p>関連タイトル：<%= result['title'] %></p>
                              <p>関連リンク：</p><%= link_to result['link'],"#{result['link']}", :target => ["'_blank'"] %>
                              <p>回数：<%= result['repeat'] %></p>
                              <p>内容：<%= result['content'] %></p>
                            </div>
                        <% end %>
                    <% elsif http_error_exist == 1 %>
                        <p>剽窃チェックができませんでした。以下の問題が考えられます。</p>
                        <p>(1)インターネットの接続に問題がありませんか。</p>
                        <p>(2)検索回数の上限を超えてませんか。</p>
                        <p>設定を確認したら、再チェックを行なってください。</p>
                    <%else %>
                        <p>WEB剽窃チェックの結果：解答に関連があるWEBページを検出できませんでした</p>
                    <%end %>
                  </div>
                </td>

              <% end %>
          <% else %>
              <td class="table-question-title-css"><%= question.title %></td>
              <td><p>-</p></td>
              <td><%= %></td>
              <td><%= %></td>
              <td><%= lesson_question.end_time %></td>
              <td><%= %>
              <% unless ENV['BING_APIKEY'].nil? %>
              <td>
              </td>
              <% end %>
          <% end %>
        </tr>
    <% end %>

  </table>
</div>
<% flash[:previous] = "student" %>
<%  @lesson_questions.each do |lesson_question| %>
<div id="internet_check_results_<%=lesson_question.question_id %>" class="internet-check-results-css" >
</div>
<% end %>
